<!DOCTYPE html>
<html>
  <head>
    <link  href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono:regular" rel="stylesheet" type="text/css" >
    <link rel=StyleSheet href="flak.css" type="text/css" media=screen>
    <title>Flak</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script type="text/javascript" src="../KievII/kievII.js"></script>
  </head>
  <body>


    <form action="">
          <input type="radio" name="buttontype" value="linear" /> linear
          <input type="radio" name="buttontype" value="halfcosine" /> halfcosine
          <input type="radio" name="buttontype" value="smooth" /> smooth
          <input type="radio" name="buttontype" value="bezier2" /> bezier2
          <input type="radio" name="buttontype" value="bezier3" /> bezier3
          <button id="addbutton" type="button" onclick="addCB(this.form)">Add</button>
          <button id="removebutton" type="button" onclick="removeCB()">Remove</button>
          <button type="button" onclick="applyCB(this.form)">Apply</button>
          <button id="clearbutton" type="button" onclick="clearCB()">CLEAR ALL</button>
          <button id="playbutton" type="button" onclick="play()">play</button>
          <button id="playbutton" type="button" onclick="stop()">stop</button>
     </form>
      
    <div>
    	<canvas id="overlay_area"
            style="z-index: 8; position:absolute; left:0px; top:35px;"
            height="762px" width="200px">
            This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
            
        <canvas id="wave_area"
            style="z-index: 5;
            position:absolute;
            left:0px;
            top:35px;"
            height="762px" width="200px">
            This text is displayed if your browser does not support HTML5 Canvas.
            </canvas>
            
        <canvas id="edit_area"
            style="z-index: 5;
            position:absolute;
            left:220px;
            top:35px;"
            height="762px" width="768px">
            This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
    </div>
      
    <script type="text/javascript">
    
    Flak = {
    	edit_area_canvas: null,
    	wave_area_canvas: null,
    	overlay_area_canvas: null,
		ui: null,
		wave_ui: null,
		overlay_ui: null,
		curveEditor: null,
		nSamples: 2048,
		bigPlayArray: [],
		currentSample: 0
    }
    
    Flak.process = function(event) {
        
        // Get left/right input and output arrays
        var outputArray = [];
        outputArray[0] = event.outputBuffer.getChannelData(0);
        outputArray[1] = event.outputBuffer.getChannelData(1);
        var dataLen = outputArray[0].length;
        
        if (Flak.playing) {
            
            for (var i = 0; i < dataLen; i+=1) {
                
                // y values are already reversed
                if (Flak.currentSample > Flak.bigPlayArray.length) {
                    Flak.playing = false;
                    break;
                }                
                else {
                    var index = Math.round(Flak.bigPlayArray[Flak.currentSample]);
                    
                    var visStep = Math.ceil((Flak.decoded_arrayL.length * 5 / Flak.wave_area_canvas.height));
                    if (!(Flak.currentSample % visStep)) {
                        var yValue = index * Flak.wave_area_canvas.height / Flak.decoded_arrayL.length;
                        Flak.overlay_ui.setValue ({elementID: 'bar', slot: "barPos", value: [0,yValue]});
                    } 
                    
                    outputArray[0][i] = Flak.decoded_arrayL[index];
                    outputArray[1][i] = Flak.decoded_arrayR[index];
                }
                Flak.currentSample+=1;
            }
        }
        
        else {
            for (var i = 0; i < dataLen; i+=1) {
                outputArray[0][i] = 0;
                outputArray[1][i] = 0;
            }
        }        
    }
  
    // Function.prototype.bind polyfill
  	if ( !Function.prototype.bind ) {
  	 
  	  Function.prototype.bind = function( obj ) {
  	    if(typeof this !== 'function') // closest thing possible to the ECMAScript 5 internal IsCallable function
  	      throw new TypeError('Function.prototype.bind - what is trying to be bound is not callable');
  	 
  	    var slice = [].slice,
  	        args = slice.call(arguments, 1),
  	        self = this,
  	        nop = function () {},
  	        bound = function () {
  	          return self.apply( this instanceof nop ? this : ( obj || {} ),
  	                              args.concat( slice.call(arguments) ) );   
  	        };
  	 
  	    bound.prototype = this.prototype;
  	 
  	    return bound;
  	  };
  	}
        
    Flak.edit_area_canvas = document.getElementById("edit_area");
    Flak.ui = new K2.UI ({type: 'CANVAS2D', target: Flak.edit_area_canvas});
    
    Flak.overlay_area_canvas = document.getElementById("overlay_area");
    Flak.overlay_ui = new K2.UI ({type: 'CANVAS2D', target: Flak.overlay_area_canvas});
    
    function initAudio () {
        Flak.audioContext = new webkitAudioContext();
        Flak.source = Flak.audioContext.createJavaScriptNode(Flak.nSamples);
        Flak.source.onaudioprocess = Flak.process;
        Flak.gainNode = Flak.audioContext.createGainNode();
        Flak.source.connect(Flak.gainNode);
        Flak.gainNode.connect(Flak.audioContext.destination);
    }
    
    function successCallback (decoded) {
        console.log ("Success!");
        
        Flak.overlay_ui.setVisible('bar', true);
        
        Flak.decoded_arrayL = decoded.getChannelData (0);
        Flak.decoded_arrayR = decoded.getChannelData (1);
        console.log ("I got the data!");
		
		var waveID = 'wavebox_L';
		
		if (!(Flak.wave_ui.isElement(waveID))) {
		
	        // Wavebox parameters
	        var waveboxArgs = {
	            ID: waveID,
	            top: 0,
	            left: 0,
	            width: Flak.wave_area_canvas.width,
	            height: Flak.wave_area_canvas.height,
	            // Todo must invert here
	            orientation: 1,
	            isListening: true,
				waveColor: '#CC0000',
				transparency: 0.8
	        };
	        
	        waveboxArgs.onValueSet = function () {
	            var that = this;
	            return function (slot, value) {
	                console.log ("onValueSet callback: slot is ", slot, " and value is ", value, " while that is ", that);
	                Flak.wave_ui.refresh();
	            };
	    	}();
	
	        var waveBox_L = new K2.Wavebox(waveboxArgs);
	        
	
	        Flak.wave_ui.addElement(waveBox_L);
        }

		// Array must be reversed (to be correctly displayed and processed)
		Array.prototype.reverse.call(Flak.decoded_arrayL);
		Array.prototype.reverse.call(Flak.decoded_arrayR);
		//var temp32Array = decoded_arrayL;
        Flak.wave_ui.setValue ({elementID: waveID, slot: "waveboxsignal", value: Flak.decoded_arrayL});     

        Flak.wave_ui.refresh();
        
        
    }
    
    function errorCallback () {
        console.log ("Error!");
        Flak.overlay_ui.setVisible('bar', false);
    }   
    
    function handleReaderLoad(evt) {
        console.log (evt);
        
        console.log ("Decoding file");
        
        Flak.audioContext.decodeAudioData(evt.target.result, successCallback, errorCallback);
        
    }
    
    function handleFiles (files) {
        
        var file = files[0];

        console.log ("Loading ", file.name);

        var reader = new FileReader();

        // init the reader event handlers
        reader.onload = handleReaderLoad;

        // begin the read operation
        reader.readAsArrayBuffer(file);
    }
 
	function drop (evt) {
		evt.stopPropagation();
        evt.preventDefault();
 
        var files = evt.dataTransfer.files;
        var count = files.length;
 
        // Only call the handler if 1 or more files was dropped.
        if (count > 0)
        handleFiles(files);
    }
 
    function noopHandler(evt) {
        evt.stopPropagation();
        evt.preventDefault();
    }
            
    var dropbox = document.getElementById("overlay_area");
 
    // init event handlers
    dropbox.addEventListener("dragenter", noopHandler, false);
    dropbox.addEventListener("dragexit", noopHandler, false);
    dropbox.addEventListener("dragover", noopHandler, false);
    dropbox.addEventListener("drop", drop, false);
    
    // initialize audio
    initAudio();
    
    // Initialize Wave UI
    //if (Flak.wave_ui !== null) {
        Flak.wave_area_canvas = document.getElementById("wave_area");
		Flak.wave_ui = new K2.UI ({type: 'CANVAS2D', target: Flak.wave_area_canvas});
	//}
	
	// the Wave Grid
    var waveGridArgs = {
        ID: "wave_grid",
        top: 0,
        left: 0,
        width: Flak.wave_area_canvas.width,
        height: Flak.wave_area_canvas.height,
        columns: 2,
        rows: 16,
        style: 'dashed',
        lineColor: 'yellow',
        bgColor: '#1f2020',
        lineWidth: 0.2,
        dashArray: [10,2]
    };
    
    var waveGrid = new K2.Grid(waveGridArgs);
    Flak.wave_ui.addElement(waveGrid);
    Flak.wave_ui.refresh();

    // the Edit Grid
    var gridArgs = {
        ID: "grid",
        top: 0,
        left: 0,
        width: Flak.edit_area_canvas.width,
        height: Flak.edit_area_canvas.height,
        columns: 16,
        rows: 16,
        style: 'dashed',
        lineColor: 'PapayaWhip',
        bgColor: '#1f2020',
        lineWidth: 0.1,
        dashArray: [12,4],
    };

    var grid = new K2.Grid(gridArgs);
    
    Flak.ui.addElement(grid);
    
    // The Overlay Bar
    barArgs = {
            ID: "bar",
            left: 0,
            top : 0,
            orientation: 1,
            thickness: 4,
            height: Flak.overlay_area_canvas.height,
            width: Flak.overlay_area_canvas.width,
            onValueSet: function (slot, value) {
                console.log ("Event on slot " + slot + " with value " + value);
                Flak.overlay_ui.refresh();
            }.bind(this),
            barColor: 'LightGreen',
            transparency: 0.5,
            isListening: true
        };
        
    Flak.overlay_ui.addElement(new K2.Bar(barArgs));
    Flak.overlay_ui.setVisible('bar', false);
    Flak.overlay_ui.refresh();
    
    // Initialize Curve
    
    // Editor callback
    var editorCallback = function (slot, value, element) {
    	if (slot === 'points') {
    		var where = Flak.ui.getProp (element, 'whereHappened');
    		Flak.overlay_ui.setValue ({elementID: 'bar', slot: "barPos", value: where});
    	}
    }
    
	Flak.curveEditor = new CurveEditor ({
    	ui: Flak.ui,
    	canvas: Flak.edit_area_canvas,
    	helperColor: "white",
    	curveColor: "LemonChiffon",
    	terminalPointFill: "SandyBrown",
    	selectedCurveColor: "Crimson",
    	callback: editorCallback,
    	curveLabels: false,
    	xMonotone: true
    });
    
    function parseCurveType (frm) { 
        var curveType = null;
        var grade = null;
            
            for (i = 0; i < frm.buttontype.length; i++) {
                if (frm.buttontype[i].checked) {
                    curveType = frm.buttontype[i].value;
                }
            }
            
            if (curveType === null) curveType = 'linear';
            
            console.log ('Add: curve type is ' + curveType);
            
            if (curveType.indexOf('bezier') == 0) {
                var grade = parseInt(curveType.charAt(6), 10);
                curveType = 'bezier';
                console.log ("Curve is bezier and grade is " + grade);
            }
            
            return [curveType, grade];
    }
    
    function addCB (frm) {
        var parsed = parseCurveType (frm);
        Flak.curveEditor.addCurve(parsed[0], parsed[1]);
    }
    
    function removeCB () {
        Flak.curveEditor.removeCurve();
    }
    
    function clearCB () {
        Flak.curveEditor.clearCurve();
    }
    
    function applyCB (frm) {
        var parsed = parseCurveType (frm);
        Flak.curveEditor.modifyCurve(parsed[0], parsed[1]);
    }
    
    function play (frm) {
        console.log ("Playing");
        
        Flak.playArray = [];
        
        var curveArray = Flak.curveEditor.status.curveArray;
        for (var i = 0; i < curveArray.length; i+=1) {
        	var curve = Flak.ui.getElement (curveArray[i]);
        	/* Time: 4 squares = the entire sample */
        	var unitaryTime = Flak.edit_area_canvas.width / 4;
        	/* sampleStartValue in the waveform: y value of the starting point of the curve
        	 * divided for the height of the canvas,
        	 * multiplied by the total sample number
        	 */
        	var sampleStartValue = (Flak.edit_area_canvas.height - curve.values.points[0][1]) / Flak.edit_area_canvas.height * Flak.decoded_arrayL.length;
        	/* Same for the end value */
        	var sampleEndValue = (Flak.edit_area_canvas.height - curve.values.points[curve.values.points.length - 1][1]) / Flak.edit_area_canvas.height * Flak.decoded_arrayL.length;
        	
        	/* samplesToPlay depends on the width of the curve (time) */
        	var samplesToPlay = (curve.values.points[curve.values.points.length - 1][0] - curve.values.points[0][0]) / Flak.edit_area_canvas.width * 4;
        	
        	console.log ("curve is: ", curveArray[i], "start / end / len: ", sampleStartValue, sampleEndValue, Flak.decoded_arrayL.length);
        	console.log ("Samples to play: ", samplesToPlay, samplesToPlay * Flak.decoded_arrayL.length);
        	
        	// Populate the Play Array
        	if (samplesToPlay !== 0) {
        	    Flak.playArray.push ({curveElement: curve,
        	                          startSample: sampleStartValue,   
        	                          endSample: sampleEndValue,
        	                          toPlay: samplesToPlay * Flak.decoded_arrayL.length});
        	}
        }
        
        // Build the big array
        Flak.bigPlayArray = [];
        Flak.currentSample = 0;
        for (i = 0; i < Flak.playArray.length; i+=1) {
                
                var currentCurve = Flak.playArray[i].curveElement;
                // How many samples we need
                var toPlay =  Flak.playArray[i].toPlay;         
                
                // The whole curve (y starts from top)
                var curvePoints = currentCurve.getCurveYPoints(toPlay, Flak.decoded_arrayL.length / currentCurve.height);
                
                Flak.bigPlayArray = Flak.bigPlayArray.concat(curvePoints);
                
                // Now, play the due curveSamples
                //var samplesIndexArray = Flak.curveSamples.slice(currentSample, dataLen); 
                
            }
        
        // Start playing
        Flak.playing = true;
        
    }
    
    function stop (frm) {
        console.log ("Stopping");
        Flak.playing = false;
    }
    
    /* Add the initial diagonal curve in the editor */
    Flak.curveEditor.addCurve('linear', 1, [0, Flak.edit_area_canvas.height], [Flak.edit_area_canvas.width, 0]);
    
                
    Flak.ui.refresh();


    </script>
  </body>
</html>
